<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">„Ç§„Éô„É≥„ÉàË©≥Á¥∞</title>
    <style>
        :root { --primary: #5e35b1; --accent: #ff5252; --bg: #f8f9ff; --text: #333; --gray: #757575; --star: #f39c12; }
        * { box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--bg); color: var(--text); min-height: 100vh; }

        .header { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; padding: 20px 40px; display: flex; justify-content: space-between; align-items: center; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.2); position: sticky; top: 0; z-index: 100;
        }
        .header h1 { margin: 0; font-size: 2em; }
        .header a { text-decoration: none; color: white; }
        #login-btn-header { 
            padding: 12px 28px; background: rgba(255,255,255,0.25); border: 2px solid rgba(255,255,255,0.4); 
            border-radius: 50px; color: white; font-weight: bold; cursor: pointer; transition: all 0.3s;
        }
        #login-btn-header:hover { background: white; color: #5e35b1; }

        .container { max-width: 900px; margin: 40px auto; padding: 40px; background: white; border-radius: 16px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); }
        .event-header { text-align: center; margin-bottom: 30px; }
        .event-header h1 { color: var(--primary); font-size: 2.4em; margin: 0 0 10px; }
        
        .avg-rating { color: var(--star); font-size: 1.2em; margin-bottom: 15px; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .avg-score { color: var(--text); font-size: 1.1em; }

        .category-badge { background: #eee; padding: 6px 14px; border-radius: 20px; font-size: 0.9em; color: #555; display: inline-block; margin-bottom: 15px; }
        .detail-image { width: 100%; max-height: 450px; object-fit: cover; border-radius: 12px; box-shadow: 0 10px 20px rgba(0,0,0,0.1); margin-bottom: 30px; }
        .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .info-item { background: #f8f9fa; padding: 20px; border-radius: 12px; border-left: 5px solid var(--primary); }
        .info-item h3 { margin: 0 0 8px; font-size: 0.9em; color: var(--gray); text-transform: uppercase; letter-spacing: 1px; }
        .info-item p { margin: 0; font-size: 1.1em; font-weight: bold; color: var(--text); }
        .tags-area { margin: 20px 0; }
        .tag-chip { display: inline-block; background: #e3f2fd; color: #1565c0; padding: 6px 12px; border-radius: 6px; margin-right: 8px; font-size: 0.9em; }
        .description { line-height: 1.9; font-size: 1.1em; color: #444; margin: 30px 0; white-space: pre-wrap; overflow-wrap: break-word; }

        .gallery-section { margin-top: 50px; border-top: 1px solid #eee; padding-top: 30px; }
        .gallery-title { font-size: 1.5em; color: var(--primary); margin-bottom: 20px; }
        .gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; }
        .gallery-item { display: block; overflow: hidden; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); transition: transform 0.2s; text-decoration: none; position: relative; }
        .gallery-item img { width: 100%; height: 180px; object-fit: cover; display: block; }

        /* --- „É¨„Éì„É•„Éº„Çª„ÇØ„Ç∑„Éß„É≥ --- */
        .reviews-section { margin-top: 60px; border-top: 3px solid #eee; padding-top: 40px; }
        .review-form { background: #f0f2f5; padding: 25px; border-radius: 16px; margin-bottom: 40px; }
        .review-form h3 { margin-top: 0; color: var(--primary); }
        .review-form input, .review-form select, .review-form textarea { 
            width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; font-size: 1em; outline: none;
        }
        .review-form textarea { height: 100px; resize: vertical; }
        #submit-review-btn { 
            background: var(--primary); color: white; border: none; padding: 12px 30px; 
            border-radius: 50px; cursor: pointer; font-weight: bold; transition: 0.2s; 
        }

        .review-item { background: white; padding: 20px; border-radius: 12px; border-bottom: 1px solid #eee; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .review-rating { color: var(--star); font-size: 1.2em; margin-bottom: 5px; }
        .review-meta { font-size: 0.85em; color: var(--gray); margin-bottom: 10px; }
        .review-comment { line-height: 1.6; color: #444; white-space: pre-wrap; margin-bottom: 10px; }
        
        /* „É¨„Éì„É•„ÉºÁîªÂÉè„Çπ„Çø„Ç§„É´ */
        .review-attached-img { max-width: 100%; max-height: 250px; border-radius: 8px; margin: 10px 0; display: block; object-fit: contain; background: #f9f9f9; }

        /* ÂΩπ„Å´Á´ã„Å£„Åü„Éú„Çø„É≥ „Çπ„Çø„Ç§„É´ */
        .helpful-area { display: flex; gap: 10px; margin-top: 15px; }
        .vote-btn { 
            background: #fff; border: 1px solid #ddd; padding: 6px 14px; border-radius: 6px; 
            cursor: pointer; font-size: 0.85em; color: #666; transition: 0.2s; display: flex; align-items: center; gap: 5px;
        }
        .vote-btn:hover { background: #f0f0f0; border-color: #ccc; }
        .vote-btn.active { border-color: var(--primary); color: var(--primary); background: #f3e5f5; }

        .action-area { text-align: center; margin-top: 40px; padding-top: 30px; border-top: 1px solid #eee; }
        #detail-favorite-btn { padding: 16px 40px; font-size: 1.1em; font-weight: bold; border: none; border-radius: 50px; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 8px 15px rgba(0,0,0,0.1); display: inline-flex; align-items: center; gap: 10px; }
        #detail-favorite-btn:not(.is-favorite) { background: #ffd740; color: #333; }
        #detail-favorite-btn.is-favorite { background: var(--accent); color: white; }

        .back-link { display: block; margin-top: 20px; color: var(--primary); text-decoration: none; font-weight: bold; }
        .modal { display: none; position: fixed; z-index: 1000; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(8px); }
        .modal-content { background: white; margin: 8% auto; padding: 40px; border-radius: 20px; width: 90%; max-width: 480px; position: relative; }
        .close-btn { position: absolute; top: 15px; right: 20px; font-size: 32px; color: #aaa; cursor: pointer; }
        .auth-buttons button { width: 100%; padding: 16px; margin: 12px 0; border: none; border-radius: 50px; color: white; font-weight: bold; cursor: pointer; }
        #google-login-btn { background: #DB4437; } #github-login-btn { background: #333; }
        #email-signup-btn, #email-login-btn { background: #4CAF50; }
        input[type="email"], input[type="password"] { width: 100%; padding: 14px; margin: 10px 0; border: 2px solid #ddd; border-radius: 50px; box-sizing: border-box; }

        @media (max-width: 600px) {
            .header { padding: 15px 20px; }
            .container { padding: 20px; margin: 15px; }
        }
    </style>
</head>
<body>

    <header class="header">
        <h1><a href="index.html">„Ç§„Éô„É≥„Éà‰∏ÄË¶ß</a></h1>
        <button id="login-btn-header">„É≠„Ç∞„Ç§„É≥ / „Çµ„Ç§„É≥„Ç¢„ÉÉ„Éó</button>
    </header>

    <div class="container">
        <div id="event-detail-container">
            <p style="text-align:center; padding:60px; font-size:1.3em; color:#777;">Ë™≠„ÅøËæº„Åø‰∏≠...</p>
        </div>

        <div id="reviews-section-wrapper" class="reviews-section" style="display:none;">
            <h3 class="gallery-title">ÂèÇÂä†ËÄÖ„ÅÆ„É¨„Éì„É•„Éº</h3>
            <div id="review-form-area"></div>
            <div id="reviews-display">„É¨„Éì„É•„Éº„ÇíË™≠„ÅøËæº„Çì„Åß„ÅÑ„Åæ„Åô...</div>
        </div>

        <div class="action-area">
            <button id="detail-favorite-btn" style="display:none;"><span>‚≠ê</span> „ÅäÊ∞ó„Å´ÂÖ•„Çä„Å´ËøΩÂä†</button>
            <br>
            <a href="index.html" class="back-link">‚Üê „Ç§„Éô„É≥„Éà‰∏ÄË¶ß„Å´Êàª„Çã</a>
        </div>
    </div>

    <div id="login-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">√ó</span>
            <h2 style="text-align:center; color:var(--primary); margin-bottom:30px;">„É≠„Ç∞„Ç§„É≥ / „Çµ„Ç§„É≥„Ç¢„ÉÉ„Éó</h2>
            <div class="auth-buttons">
                <button id="google-login-btn">Google„Åß„É≠„Ç∞„Ç§„É≥</button>
                <button id="github-login-btn">GitHub„Åß„É≠„Ç∞„Ç§„É≥</button>
            </div>
            <hr style="margin:30px 0; border:0; border-top:1px solid #eee;">
            <input type="email" id="email-input" placeholder="„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ">
            <input type="password" id="password-input" placeholder="„Éë„Çπ„ÉØ„Éº„ÉâÔºà6ÊñáÂ≠ó‰ª•‰∏äÔºâ">
            <div class="auth-buttons">
                <button id="email-signup-btn">„Ç¢„Ç´„Ç¶„É≥„Éà‰ΩúÊàê</button>
                <button id="email-login-btn">„É≠„Ç∞„Ç§„É≥</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, GithubAuthProvider, signInWithPopup, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc, arrayUnion, arrayRemove, setDoc, collection, addDoc, serverTimestamp, query, orderBy, onSnapshot, increment } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDt69H-dBGMB4HANbwVj007vJ3yblEZdqE",
            authDomain: "goto6234.firebaseapp.com",
            projectId: "goto6234",
            storageBucket: "goto6234.firebasestorage.app",
            messagingSenderId: "730149609843",
            appId: "1:730149609843:web:d11237de52723fc45b2506"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        let currentUser = null;
        let eventId = new URLSearchParams(location.search).get('id');
        const modal = document.getElementById('login-modal');
        const loginBtn = document.getElementById('login-btn-header');

        // --- ÊäïÁ•®Ê©üËÉΩ („Ç∞„É≠„Éº„Éê„É´„Å´Èñ¢Êï∞„ÇíÂÖ¨Èñã) ---
        window.voteReview = async (reviewId, type) => {
            if (!currentUser) { alert("ÊäïÁ•®„Åô„Çã„Å´„ÅØ„É≠„Ç∞„Ç§„É≥„ÅåÂøÖË¶Å„Åß„Åô"); modal.style.display = 'block'; return; }
            
            const reviewRef = doc(db, 'events', eventId, 'reviews', reviewId);
            const field = type === 'up' ? 'helpfulCount' : 'notHelpfulCount';
            
            try {
                await updateDoc(reviewRef, { [field]: increment(1) });
            } catch (e) {
                console.error("ÊäïÁ•®„Ç®„É©„Éº:", e);
            }
        };

        // --- „É¨„Éì„É•„ÉºÊäïÁ®ø ---
        const submitReview = async () => {
            const rating = document.getElementById('review-rating').value;
            const comment = document.getElementById('review-comment').value.trim();
            const imgUrl = document.getElementById('review-image-url').value.trim();
            const btn = document.getElementById('submit-review-btn');

            if (!comment) return alert("„Ç≥„É°„É≥„Éà„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ");
            
            btn.disabled = true;
            try {
                const reviewsRef = collection(db, 'events', eventId, 'reviews');
                await addDoc(reviewsRef, {
                    reviewerUid: currentUser.uid,
                    reviewerName: currentUser.displayName || currentUser.email.split('@')[0],
                    reviewRating: parseInt(rating),
                    reviewComment: comment,
                    reviewImageUrl: imgUrl, // ÁîªÂÉèURL„ÇíËøΩÂä†
                    helpfulCount: 0,        // ÂàùÊúüÂÄ§
                    notHelpfulCount: 0,    // ÂàùÊúüÂÄ§
                    postedAt: serverTimestamp()
                });
                alert("ÊäïÁ®ø„Åó„Åæ„Åó„ÅüÔºÅ");
            } catch (e) {
                alert("ÊäïÁ®ø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü");
            } finally {
                btn.disabled = false;
            }
        };

        const renderReviewUI = () => {
            const formArea = document.getElementById('review-form-area');
            if (currentUser) {
                formArea.innerHTML = `
                    <div class="review-form">
                        <h3>„É¨„Éì„É•„Éº„ÇíÊäïÁ®ø</h3>
                        <label>Ë©ï‰æ°Ôºö</label>
                        <select id="review-rating">
                            <option value="5">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ (5)</option>
                            <option value="4">‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ (4)</option>
                            <option value="3" selected>‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ (3)</option>
                            <option value="2">‚òÖ‚òÖ‚òÜ‚òÜ‚òÜ (2)</option>
                            <option value="1">‚òÖ‚òÜ‚òÜ‚òÜ‚òÜ (1)</option>
                        </select>
                        <textarea id="review-comment" placeholder="ÊÑüÊÉ≥„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ"></textarea>
                        <input type="url" id="review-image-url" placeholder="ÁîªÂÉè„ÅÆURL„Åå„ÅÇ„Çå„Å∞ÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ (https://...)">
                        <button id="submit-review-btn">ÊäïÁ®ø„Åô„Çã</button>
                    </div>
                `;
                document.getElementById('submit-review-btn').onclick = submitReview;
            } else {
                formArea.innerHTML = `<div class="review-form" style="text-align:center;"><p>„É≠„Ç∞„Ç§„É≥„Åó„Å¶„É¨„Éì„É•„Éº„ÇíÊäïÁ®ø</p></div>`;
            }
        };

        const initReviewsRealtime = () => {
            const reviewsRef = collection(db, 'events', eventId, 'reviews');
            const q = query(reviewsRef, orderBy('postedAt', 'desc'));

            onSnapshot(q, (snapshot) => {
                const displayArea = document.getElementById('reviews-display');
                const avgDisplay = document.getElementById('average-rating-display');
                if (snapshot.empty) { displayArea.innerHTML = '<p>„Åæ„Å†„É¨„Éì„É•„Éº„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</p>'; return; }

                let totalScore = 0;
                const reviewListHtml = snapshot.docs.map(docSnap => {
                    const r = docSnap.data();
                    const rid = docSnap.id;
                    totalScore += r.reviewRating;
                    const stars = '‚òÖ'.repeat(r.reviewRating) + '‚òÜ'.repeat(5 - r.reviewRating);
                    
                    // ÁîªÂÉè„Åå„ÅÇ„Çå„Å∞Ë°®Á§∫
                    const imgTag = r.reviewImageUrl ? `<img src="${r.reviewImageUrl}" class="review-attached-img" alt="„É¨„Éì„É•„ÉºÁîªÂÉè" onerror="this.style.display='none'">` : '';
                    
                    return `
                        <div class="review-item">
                            <div class="review-rating">${stars}</div>
                            <div class="review-meta"><strong>${r.reviewerName}</strong></div>
                            <div class="review-comment">${r.reviewComment}</div>
                            ${imgTag}
                            <div class="helpful-area">
                                <button class="vote-btn" onclick="voteReview('${rid}', 'up')">üëç ÂΩπ„Å´Á´ã„Å£„Åü (${r.helpfulCount || 0})</button>
                                <button class="vote-btn" onclick="voteReview('${rid}', 'down')">üëé ÂΩπ„Å´Á´ã„Åü„Å™„Åã„Å£„Åü (${r.notHelpfulCount || 0})</button>
                            </div>
                        </div>
                    `;
                }).join('');

                const average = (totalScore / snapshot.size).toFixed(1);
                if(avgDisplay) avgDisplay.innerHTML = `<span>‚òÖ</span> ${average} <small>(${snapshot.size}‰ª∂)</small>`;
                displayArea.innerHTML = reviewListHtml;
            });
        };

        // --- ÂàùÊúüÂåñÂá¶ÁêÜ (‰ª•Ââç„ÅÆ„Ç≥„Éº„Éâ„ÅÆÁ∂ö„Åç) ---
        onAuthStateChanged(auth, user => {
            currentUser = user;
            if (user) {
                loginBtn.textContent = `${user.displayName || user.email.split('@')[0]} „Åï„Çì`;
            }
            renderReviewUI();
        });

        // ‰ª•‰∏ã„ÄÅ„Ç§„Éô„É≥„ÉàË©≥Á¥∞Ë™≠„ÅøËæº„Åø„Å™„Å©„ÅØÂ§âÊõ¥„Å™„Åó„ÅÆ„Åü„ÇÅÁúÅÁï•
        const loadEventDetail = async () => {
            if (!eventId) return;
            try {
                const snap = await getDoc(doc(db, 'events', eventId));
                const data = snap.data();
                document.getElementById('event-detail-container').innerHTML = `
                    <div class="event-header">
                        <h1>${data.name}</h1>
                        <div id="average-rating-display" class="avg-rating"></div>
                    </div>
                    <img src="${data.imageUrl || ''}" class="detail-image">
                    <p class="description">${data.description}</p>
                `;
                document.getElementById('reviews-section-wrapper').style.display = 'block';
                initReviewsRealtime();
            } catch (e) { console.error(e); }
        };
        loadEventDetail();

        // „É¢„Éº„ÉÄ„É´Âà∂Âæ°
        document.querySelector('.close-btn').onclick = () => modal.style.display = 'none';
    </script>
</body>
</html>
