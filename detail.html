<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">イベント詳細</title>
    <style>
        :root { --primary: #5e35b1; --accent: #ff5252; --bg: #f8f9ff; --text: #333; --gray: #757575; --star: #f39c12; }
        * { box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--bg); color: var(--text); min-height: 100vh; }

        .header { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; padding: 20px 40px; display: flex; justify-content: space-between; align-items: center; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.2); position: sticky; top: 0; z-index: 100;
        }
        .header h1 { margin: 0; font-size: 2em; }
        .header a { text-decoration: none; color: white; }
        #login-btn-header { 
            padding: 12px 28px; background: rgba(255,255,255,0.25); border: 2px solid rgba(255,255,255,0.4); 
            border-radius: 50px; color: white; font-weight: bold; cursor: pointer; transition: all 0.3s;
        }
        #login-btn-header:hover { background: white; color: #5e35b1; }

        .container { max-width: 900px; margin: 40px auto; padding: 40px; background: white; border-radius: 16px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); }
        .event-header { text-align: center; margin-bottom: 30px; }
        .event-header h1 { color: var(--primary); font-size: 2.4em; margin: 0 0 15px; }
        .category-badge { background: #eee; padding: 6px 14px; border-radius: 20px; font-size: 0.9em; color: #555; display: inline-block; margin-bottom: 15px; }
        .detail-image { width: 100%; max-height: 450px; object-fit: cover; border-radius: 12px; box-shadow: 0 10px 20px rgba(0,0,0,0.1); margin-bottom: 30px; }
        .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .info-item { background: #f8f9fa; padding: 20px; border-radius: 12px; border-left: 5px solid var(--primary); }
        .info-item h3 { margin: 0 0 8px; font-size: 0.9em; color: var(--gray); text-transform: uppercase; letter-spacing: 1px; }
        .info-item p { margin: 0; font-size: 1.1em; font-weight: bold; color: var(--text); }
        .tags-area { margin: 20px 0; }
        .tag-chip { display: inline-block; background: #e3f2fd; color: #1565c0; padding: 6px 12px; border-radius: 6px; margin-right: 8px; font-size: 0.9em; }
        .description { line-height: 1.9; font-size: 1.1em; color: #444; margin: 30px 0; white-space: pre-wrap; overflow-wrap: break-word; }

        .gallery-section { margin-top: 50px; border-top: 1px solid #eee; padding-top: 30px; }
        .gallery-title { font-size: 1.5em; color: var(--primary); margin-bottom: 20px; }
        .gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; }
        .gallery-item { display: block; overflow: hidden; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); transition: transform 0.2s; text-decoration: none; position: relative; }
        .gallery-item:hover { transform: scale(1.02); }
        .gallery-item img { width: 100%; height: 180px; object-fit: cover; display: block; }

        /* --- レビューセクションのスタイル --- */
        .reviews-section { margin-top: 60px; border-top: 3px solid #eee; padding-top: 40px; }
        .review-form { background: #f0f2f5; padding: 25px; border-radius: 16px; margin-bottom: 40px; }
        .review-form h3 { margin-top: 0; color: var(--primary); }
        .review-form select, .review-form textarea { 
            width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; font-size: 1em; outline: none;
        }
        .review-form textarea { height: 120px; resize: vertical; }
        #submit-review-btn { 
            background: var(--primary); color: white; border: none; padding: 12px 30px; 
            border-radius: 50px; cursor: pointer; font-weight: bold; transition: transform 0.2s, opacity 0.2s; 
        }
        #submit-review-btn:hover { transform: translateY(-2px); opacity: 0.9; }
        #submit-review-btn:disabled { background: #ccc; cursor: not-allowed; }

        .review-item { background: white; padding: 20px; border-radius: 12px; border-bottom: 1px solid #eee; margin-bottom: 10px; }
        .review-rating { color: var(--star); font-size: 1.2em; margin-bottom: 5px; }
        .review-meta { font-size: 0.85em; color: var(--gray); margin-bottom: 10px; }
        .review-comment { line-height: 1.6; color: #444; white-space: pre-wrap; }

        .action-area { text-align: center; margin-top: 40px; padding-top: 30px; border-top: 1px solid #eee; }
        #detail-favorite-btn { padding: 16px 40px; font-size: 1.1em; font-weight: bold; border: none; border-radius: 50px; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 8px 15px rgba(0,0,0,0.1); display: inline-flex; align-items: center; gap: 10px; }
        #detail-favorite-btn:not(.is-favorite) { background: #ffd740; color: #333; }
        #detail-favorite-btn.is-favorite { background: var(--accent); color: white; animation: pulse 0.5s; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

        .back-link { display: block; margin-top: 20px; color: var(--primary); text-decoration: none; font-weight: bold; }
        .modal { display: none; position: fixed; z-index: 1000; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(8px); }
        .modal-content { background: white; margin: 8% auto; padding: 40px; border-radius: 20px; width: 90%; max-width: 480px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); animation: modalIn 0.4s; position: relative; }
        @keyframes modalIn { from { transform: translateY(-100px); opacity: 0; } to { transform: none; opacity: 1; } }
        .close-btn { position: absolute; top: 15px; right: 20px; font-size: 32px; color: #aaa; cursor: pointer; }
        .auth-buttons button { width: 100%; padding: 16px; margin: 12px 0; border: none; border-radius: 50px; color: white; font-weight: bold; font-size: 1.1em; cursor: pointer; }
        #google-login-btn { background: #DB4437; } #github-login-btn { background: #333; }
        #email-signup-btn, #email-login-btn { background: #4CAF50; }
        input[type="email"], input[type="password"] { width: 100%; padding: 14px; margin: 10px 0; border: 2px solid #ddd; border-radius: 50px; box-sizing: border-box; font-size: 1em; }

        @media (max-width: 600px) {
            .header { padding: 15px 20px; flex-direction: column; text-align: center; }
            .container { padding: 20px; margin: 15px; }
            .info-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <header class="header">
        <h1><a href="index.html">イベント一覧</a></h1>
        <button id="login-btn-header">ログイン / サインアップ</button>
    </header>

    <div class="container">
        <div id="event-detail-container">
            <p style="text-align:center; padding:60px; font-size:1.3em; color:#777;">読み込み中...</p>
        </div>

        <div id="reviews-section-wrapper" class="reviews-section" style="display:none;">
            <h3 class="gallery-title">参加者のレビュー</h3>
            <div id="review-form-area"></div>
            <div id="reviews-display">レビューを読み込んでいます...</div>
        </div>

        <div class="action-area">
            <button id="detail-favorite-btn" style="display:none;"><span>⭐</span> お気に入りに追加</button>
            <br>
            <a href="index.html" class="back-link">← イベント一覧に戻る</a>
        </div>
    </div>

    <div id="login-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">×</span>
            <h2 style="text-align:center; color:var(--primary); margin-bottom:30px;">ログイン / サインアップ</h2>
            <div class="auth-buttons">
                <button id="google-login-btn">Googleでログイン</button>
                <button id="github-login-btn">GitHubでログイン</button>
            </div>
            <hr style="margin:30px 0; border:0; border-top:1px solid #eee;">
            <input type="email" id="email-input" placeholder="メールアドレス">
            <input type="password" id="password-input" placeholder="パスワード（6文字以上）">
            <div class="auth-buttons">
                <button id="email-signup-btn">アカウント作成</button>
                <button id="email-login-btn">ログイン</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, GithubAuthProvider, signInWithPopup, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc, arrayUnion, arrayRemove, setDoc, collection, addDoc, serverTimestamp, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDt69H-dBGMB4HANbwVj007vJ3yblEZdqE",
            authDomain: "goto6234.firebaseapp.com",
            projectId: "goto6234",
            storageBucket: "goto6234.firebasestorage.app",
            messagingSenderId: "730149609843",
            appId: "1:730149609843:web:d11237de52723fc45b2506"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        const container = document.getElementById('event-detail-container');
        const pageTitle = document.getElementById('page-title');
        const modal = document.getElementById('login-modal');
        const loginBtn = document.getElementById('login-btn-header');
        const closeBtn = document.querySelector('.close-btn');

        let currentUser = null;
        let isFavorite = false;
        let eventId = new URLSearchParams(location.search).get('id');
        const categoryNames = { matsuri: "祭り", music: "音楽", learn: "学び", workshop: "ワークショップ", sports: "スポーツ", gourmet: "グルメ", exhibition: "展示・芸術" };

        // --- 認証関連 ---
        loginBtn.onclick = () => { if (!currentUser) modal.style.display = 'block'; };
        closeBtn.onclick = () => modal.style.display = 'none';
        window.onclick = e => { if (e.target === modal) modal.style.display = 'none'; };

        const googleProvider = new GoogleAuthProvider();
        const githubProvider = new GithubAuthProvider();

        document.getElementById('google-login-btn').onclick = () => signInWithPopup(auth, googleProvider).then(() => modal.style.display = 'none').catch(e => alert(e.message));
        document.getElementById('github-login-btn').onclick = () => signInWithPopup(auth, githubProvider).then(() => modal.style.display = 'none').catch(e => alert(e.message));
        document.getElementById('email-signup-btn').onclick = () => {
            const email = document.getElementById('email-input').value.trim();
            const pass = document.getElementById('password-input').value;
            if (email && pass.length >= 6) createUserWithEmailAndPassword(auth, email, pass).then(() => modal.style.display = 'none').catch(e => alert(e.message));
            else alert("パスワードは6文字以上必要です");
        };
        document.getElementById('email-login-btn').onclick = () => {
            const email = document.getElementById('email-input').value.trim();
            const pass = document.getElementById('password-input').value;
            if (email && pass) signInWithEmailAndPassword(auth, email, pass).then(() => modal.style.display = 'none').catch(e => alert(e.message));
        };

        // --- レビュー投稿機能 ---
        const submitReview = async () => {
            const rating = document.getElementById('review-rating').value;
            const comment = document.getElementById('review-comment').value.trim();
            const btn = document.getElementById('submit-review-btn');

            if (!comment) return alert("コメントを入力してください");
            
            btn.disabled = true;
            try {
                const reviewsRef = collection(db, 'events', eventId, 'reviews');
                await addDoc(reviewsRef, {
                    reviewerUid: currentUser.uid,
                    reviewerName: currentUser.displayName || currentUser.email.split('@')[0],
                    reviewRating: parseInt(rating),
                    reviewComment: comment,
                    postedAt: serverTimestamp()
                });
                document.getElementById('review-comment').value = "";
                alert("投稿ありがとうございます！");
            } catch (e) {
                console.error(e);
                alert("投稿に失敗しました");
            } finally {
                btn.disabled = false;
            }
        };

        // レビューUIの描画
        const renderReviewUI = () => {
            const formArea = document.getElementById('review-form-area');
            if (currentUser) {
                formArea.innerHTML = `
                    <div class="review-form">
                        <h3>このイベントの感想を投稿する</h3>
                        <label>評価：</label>
                        <select id="review-rating">
                            <option value="5">★★★★★ (5)</option>
                            <option value="4">★★★★☆ (4)</option>
                            <option value="3" selected>★★★☆☆ (3)</option>
                            <option value="2">★★☆☆☆ (2)</option>
                            <option value="1">★☆☆☆☆ (1)</option>
                        </select>
                        <textarea id="review-comment" placeholder="イベントはいかがでしたか？（会場の雰囲気や内容など）"></textarea>
                        <button id="submit-review-btn">レビューを投稿する</button>
                    </div>
                `;
                document.getElementById('submit-review-btn').onclick = submitReview;
            } else {
                formArea.innerHTML = `
                    <div class="review-form" style="text-align:center;">
                        <p>レビューを投稿するにはログインが必要です</p>
                        <button onclick="document.getElementById('login-modal').style.display='block'" 
                            style="background:var(--primary); color:white; border:none; padding:10px 25px; border-radius:50px; cursor:pointer; font-weight:bold;">
                            ログインして投稿する
                        </button>
                    </div>
                `;
            }
        };

        // レビューのリアルタイム表示
        const initReviewsRealtime = () => {
            const reviewsRef = collection(db, 'events', eventId, 'reviews');
            const q = query(reviewsRef, orderBy('postedAt', 'desc'));

            onSnapshot(q, (snapshot) => {
                const displayArea = document.getElementById('reviews-display');
                if (snapshot.empty) {
                    displayArea.innerHTML = '<p style="color:#999; text-align:center; padding:20px;">まだレビューはありません。最初の投稿者になりましょう！</p>';
                    return;
                }

                displayArea.innerHTML = snapshot.docs.map(doc => {
                    const r = doc.data();
                    const date = r.postedAt ? r.postedAt.toDate().toLocaleDateString() : '投稿中...';
                    const stars = '★'.repeat(r.reviewRating) + '☆'.repeat(5 - r.reviewRating);
                    return `
                        <div class="review-item">
                            <div class="review-rating">${stars}</div>
                            <div class="review-meta"><strong>${r.reviewerName}</strong> | ${date}</div>
                            <div class="review-comment">${r.reviewComment}</div>
                        </div>
                    `;
                }).join('');
            });
        };

        // --- お気に入り機能 ---
        const checkFavoriteStatus = async () => {
            if (!currentUser || !eventId) return;
            const snap = await getDoc(doc(db, 'users', currentUser.uid));
            isFavorite = snap.exists() ? (snap.data().favorites || []).includes(eventId) : false;
            updateFavoriteButton();
        };

        const updateFavoriteButton = () => {
            const btn = document.getElementById('detail-favorite-btn');
            if(!btn) return;
            btn.style.display = 'inline-flex';
            if (isFavorite) {
                btn.classList.add('is-favorite');
                btn.innerHTML = '<span>❤️</span> お気に入り解除';
            } else {
                btn.classList.remove('is-favorite');
                btn.innerHTML = '<span>⭐</span> お気に入りに追加';
            }
        };

        const toggleFavorite = async () => {
            if (!currentUser) { modal.style.display = 'block'; return; }
            const userRef = doc(db, 'users', currentUser.uid);
            isFavorite = !isFavorite;
            updateFavoriteButton();
            try {
                if (!isFavorite) { await updateDoc(userRef, { favorites: arrayRemove(eventId) }); }
                else { await setDoc(userRef, { favorites: arrayUnion(eventId) }, { merge: true }); }
            } catch (e) { console.error(e); isFavorite = !isFavorite; updateFavoriteButton(); }
        };

        // --- メイン読み込み処理 ---
        const loadEventDetail = async () => {
            if (!eventId) { container.innerHTML = '<p style="text-align:center;color:red;">不正なアクセスです</p>'; return; }

            try {
                const snap = await getDoc(doc(db, 'events', eventId));
                if (!snap.exists()) { container.innerHTML = '<p style="text-align:center;color:red;">イベントが見つかりません</p>'; return; }

                const data = snap.data();
                const timeDisplay = data.startTime ? `${data.startTime} 〜 ${data.endTime || ""}` : "終日";
                const imgHtml = data.imageUrl ? `<img src="${data.imageUrl}" class="detail-image" alt="${data.name}">` : `<div style="height:300px;background:#eee;border-radius:12px;display:flex;align-items:center;justify-content:center;color:#999;margin-bottom:30px;">画像なし</div>`;
                const catLabel = categoryNames[data.category] || data.category || "未分類";
                
                let tagsHtml = (data.tags || []).map(t => `<span class="tag-chip">#${t}</span>`).join('');
                let galleryHtml = (data.subImages || []).map(url => `
                    <a href="${url}" target="_blank" class="gallery-item"><img src="${url}" alt="詳細" loading="lazy"></a>
                `).join('');

                container.innerHTML = `
                    <div class="event-header">
                        <span class="category-badge">${catLabel}</span>
                        <h1>${data.name}</h1>
                    </div>
                    ${imgHtml}
                    <div class="info-grid">
                        <div class="info-item"><h3>Date</h3><p>${data.date}</p></div>
                        <div class="info-item"><h3>Time</h3><p>${timeDisplay}</p></div>
                        <div class="info-item"><h3>Venue</h3><p>${data.venue || "未定"}</p></div>
                        <div class="info-item"><h3>Organizer</h3><p>${data.organizer || "-"}</p></div>
                    </div>
                    <div class="tags-area">${tagsHtml}</div>
                    <h2>イベント概要</h2>
                    <div class="description">${data.description || "詳細情報はありません。"}</div>
                    ${galleryHtml ? `<div class="gallery-section"><h3 class="gallery-title">ギャラリー</h3><div class="gallery-grid">${galleryHtml}</div></div>` : ''}
                `;

                pageTitle.textContent = `${data.name} | イベント詳細`;
                document.getElementById('reviews-section-wrapper').style.display = 'block';
                document.getElementById('detail-favorite-btn').onclick = toggleFavorite;

                renderReviewUI();
                initReviewsRealtime();
                if(currentUser) await checkFavoriteStatus();

            } catch (e) {
                console.error(e);
                container.innerHTML = '<p style="text-align:center;color:red;">データの取得に失敗しました</p>';
            }
        };

        onAuthStateChanged(auth, user => {
            currentUser = user;
            if (user) {
                loginBtn.textContent = `${user.displayName || user.email.split('@')[0]} さん`;
                loginBtn.onclick = () => location.href = 'mypage.html';
                checkFavoriteStatus();
            } else {
                loginBtn.textContent = 'ログイン / サインアップ';
                loginBtn.onclick = () => modal.style.display = 'block';
            }
            renderReviewUI(); // ログイン状態が変わったらフォームも再描画
        });

        loadEventDetail();
    </script>
</body>
</html>
