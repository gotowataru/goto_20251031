<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ­ã‚°ã‚¤ãƒ³ / ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ— (ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒªãƒ³ã‚¯å¯¾å¿œ)</title>
    <style>
        body { font-family: sans-serif; margin: 30px; background-color: #f4f7f6; }
        .container { max-width: 400px; margin: 0 auto; background: white; padding: 25px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #333; margin-bottom: 20px; }
        input[type="email"], input[type="password"] {
            width: 100%; padding: 10px; margin: 8px 0; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px;
        }
        .auth-buttons button {
            width: 100%; padding: 12px; margin-bottom: 10px; border: none; border-radius: 4px; cursor: pointer; color: white; font-weight: bold;
        }
        #email-signup-btn, #email-login-btn { background-color: #4CAF50; }
        #google-login-btn { background-color: #DB4437; }
        #github-login-btn { background-color: #333; }
        #reauth-section { display: none; margin-top: 20px; padding: 15px; border: 1px solid #ffcc80; background-color: #fff3e0; border-radius: 4px; }
        hr { margin: 20px 0; border: 0; border-top: 1px solid #eee; }
    </style>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { 
            getAuth, 
            GoogleAuthProvider, 
            GithubAuthProvider,
            signInWithPopup, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            onAuthStateChanged,
            linkWithCredential, // â˜… ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒªãƒ³ã‚¯ç”¨ã«è¿½åŠ 
            EmailAuthProvider, // â˜… å†èªè¨¼ç”¨ã«è¿½åŠ 
            reauthenticateWithCredential // â˜… å†èªè¨¼ç”¨ã«è¿½åŠ 
        } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

        // ã‚ãªãŸã®ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã®Firebaseè¨­å®š
        const firebaseConfig = {
            apiKey: "AIzaSyDt69H-dBGMB4HANbwVj007vJ3yblEZdqE",
            authDomain: "goto6234.firebaseapp.com",
            projectId: "goto6234",
            storageBucket: "goto6234.firebasestorage.app",
            messagingSenderId: "730149609843",
            appId: "1:730149609843:web:d11237de52723fc45b2506",
            measurementId: "G-FDRB7H8MRR"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app); 
        const googleProvider = new GoogleAuthProvider();
        const githubProvider = new GithubAuthProvider();

        const reauthSection = document.getElementById('reauth-section');
        const reauthEmailInput = document.getElementById('reauth-email-input');
        const reauthPasswordInput = document.getElementById('reauth-password-input');
        
        let pendingCredential = null; // ãƒªãƒ³ã‚¯å¾…ã¡ã®èªè¨¼æƒ…å ±ã‚’ä¿æŒã™ã‚‹ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°

        // ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸæ™‚ã«ãƒã‚¤ãƒšãƒ¼ã‚¸ã¸é·ç§»ã•ã›ã‚‹é–¢æ•°
        const handleLoginSuccess = (message) => {
            alert(message);
            window.location.href = 'mypage.html';
        };

        // èªè¨¼çŠ¶æ…‹ã®ç›£è¦– (ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ãªã‚‰ãƒã‚¤ãƒšãƒ¼ã‚¸ã¸å³æ™‚ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ)
        onAuthStateChanged(auth, (user) => {
            if (user) {
                window.location.href = 'mypage.html';
            }
        });

        // --- å…±é€šã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°é–¢æ•° ---
        const handleSocialLoginError = async (error, provider) => {
            if (error.code === 'auth/account-exists-with-different-credential') {
                const email = error.customData.email;
                
                // ãƒªãƒ³ã‚¯å¾…ã¡ã®èªè¨¼æƒ…å ±ã‚’å–å¾—ãƒ»ä¿å­˜
                pendingCredential = provider.credentialFromResult(error);

                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«çŠ¶æ³ã‚’èª¬æ˜
                alert(`ã“ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ (${email}) ã¯ã€ã™ã§ã«åˆ¥ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€‚å…ˆã«ãã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆï¼ˆGoogleã‚„ãƒ¡ãƒ¼ãƒ«/ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãªã©ï¼‰ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã€GitHubã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ãƒªãƒ³ã‚¯ã—ã¾ã™ã€‚`);
                
                // æ—¢å­˜ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å†èªè¨¼ãƒ•ã‚©ãƒ¼ãƒ ã«è¡¨ç¤º
                reauthEmailInput.value = email;
                // å†èªè¨¼ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤ºã—ã€ä»–ã®ãƒ•ã‚©ãƒ¼ãƒ ã‚’éè¡¨ç¤ºã«
                document.getElementById('login-form-main').style.display = 'none';
                reauthSection.style.display = 'block';

            } else {
                // ãã®ä»–ã®ä¸€èˆ¬çš„ãªãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼
                console.error(`${provider.providerId} ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼:`, error);
                alert(`${provider.providerId} ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ: ` + error.message);
            }
        };

        // --- ã‚½ãƒ¼ã‚·ãƒ£ãƒ«ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç† ---

        // Googleãƒ­ã‚°ã‚¤ãƒ³
        document.getElementById('google-login-btn').addEventListener('click', async () => {
            try {
                await signInWithPopup(auth, googleProvider);
                handleLoginSuccess('Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸï¼');
            } catch (error) {
                // Google Providerã¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ç›´æ¥æ¸¡ã›ãªã„ã®ã§ã€ãƒ—ãƒ­ãƒã‚¤ãƒ€IDã§åˆ¤æ–­
                handleSocialLoginError(error, GoogleAuthProvider);
            }
        });

        // GitHubãƒ­ã‚°ã‚¤ãƒ³
        document.getElementById('github-login-btn').addEventListener('click', async () => {
            try {
                await signInWithPopup(auth, githubProvider);
                handleLoginSuccess('GitHubã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸï¼');
            } catch (error) {
                // GitHub Providerã¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ç›´æ¥æ¸¡ã›ãªã„ã®ã§ã€ãƒ—ãƒ­ãƒã‚¤ãƒ€IDã§åˆ¤æ–­
                handleSocialLoginError(error, GithubAuthProvider);
            }
        });

        // --- Email/Password å‡¦ç† ---
        const emailInput = document.getElementById('email-input');
        const passwordInput = document.getElementById('password-input');

        // Emailã§ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ— (æˆåŠŸæ™‚ã«ãƒã‚¤ãƒšãƒ¼ã‚¸ã¸)
        document.getElementById('email-signup-btn').addEventListener('click', async () => {
            const email = emailInput.value;
            const password = passwordInput.value;
            if (!email || !password) return alert('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
            try {
                await createUserWithEmailAndPassword(auth, email, password);
                handleLoginSuccess('ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆã—ã¾ã—ãŸï¼');
            } catch (error) {
                console.error("Emailã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ã‚¨ãƒ©ãƒ¼:", error);
                alert("Emailã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ã«å¤±æ•—ã—ã¾ã—ãŸ: " + error.message);
            }
        });

        // Emailã§ãƒ­ã‚°ã‚¤ãƒ³ (æˆåŠŸæ™‚ã«ãƒã‚¤ãƒšãƒ¼ã‚¸ã¸)
        document.getElementById('email-login-btn').addEventListener('click', async () => {
            const email = emailInput.value;
            const password = passwordInput.value;
            if (!email || !password) return alert('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
            try {
                await signInWithEmailAndPassword(auth, email, password);
                handleLoginSuccess('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸï¼');
            } catch (error) {
                console.error("Emailãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼:", error);
                alert("Emailãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ: " + error.message);
            }
        });
        
        // --- ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒªãƒ³ã‚¯å‡¦ç† ---

        // å†èªè¨¼ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        document.getElementById('reauth-login-btn').addEventListener('click', async () => {
            const email = reauthEmailInput.value;
            const password = reauthPasswordInput.value;
            if (!email || !password) return alert('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');

            if (!pendingCredential || !auth.currentUser) {
                alert('ã‚¨ãƒ©ãƒ¼: ãƒªãƒ³ã‚¯å¯¾è±¡ã®èªè¨¼æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã—ã¦ãã ã•ã„ã€‚');
                window.location.reload();
                return;
            }

            try {
                // 1. æ—¢å­˜ã®èªè¨¼æƒ…å ±ã§å†ãƒ­ã‚°ã‚¤ãƒ³ã—ã€ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥
                const credential = EmailAuthProvider.credential(email, password);
                await reauthenticateWithCredential(auth.currentUser, credential);
                
                // 2. æ–°ã—ã„ãƒ—ãƒ­ãƒã‚¤ãƒ€ï¼ˆGitHub/Googleï¼‰ã®èªè¨¼æƒ…å ±ã‚’æ—¢å­˜ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ãƒªãƒ³ã‚¯
                await linkWithCredential(auth.currentUser, pendingCredential);
                
                // æˆåŠŸ
                alert('ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ãƒªãƒ³ã‚¯ãŒå®Œäº†ã—ã¾ã—ãŸï¼');
                handleLoginSuccess('è¤‡æ•°ã®æ–¹æ³•ã§ãƒ­ã‚°ã‚¤ãƒ³ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸï¼');

            } catch (error) {
                console.error("ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒªãƒ³ã‚¯/å†èªè¨¼ã‚¨ãƒ©ãƒ¼:", error);
                alert("ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ãƒªãƒ³ã‚¯ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ­£ã—ã„ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ãŸã‹ç¢ºèªã—ã¦ãã ã•ã„: " + error.message);
            }
        });
    </script>
</head>
<body>
    <div class="container">
        <h1>ğŸ” èªè¨¼ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸</h1>
        <div id="login-form-main">
            <h2>ã‚½ãƒ¼ã‚·ãƒ£ãƒ«ãƒ­ã‚°ã‚¤ãƒ³</h2>
            <div class="auth-buttons">
                <button id="google-login-btn">Googleã§ãƒ­ã‚°ã‚¤ãƒ³</button>
                <button id="github-login-btn">GitHubã§ãƒ­ã‚°ã‚¤ãƒ³</button>
            </div>

            <hr>

            <h2>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§èªè¨¼</h2>
            <div>
                <input type="email" id="email-input" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" required>
                <input type="password" id="password-input" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" required>
                <div class="auth-buttons">
                    <button id="email-signup-btn">ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ— (ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ)</button>
                    <button id="email-login-btn">ãƒ­ã‚°ã‚¤ãƒ³</button>
                </div>
            </div>
        </div>

        <div id="reauth-section">
            <h2>ğŸ¤ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒªãƒ³ã‚¯</h2>
            <p><strong>ã“ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯æ—¢å­˜ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€‚</strong><br>
                æ—¢å­˜ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®èªè¨¼æƒ…å ±ï¼ˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼‰ã‚’å…¥åŠ›ã—ã¦ã€æ–°ã—ã„ãƒ—ãƒ­ãƒã‚¤ãƒ€ã‚’ãƒªãƒ³ã‚¯ã—ã¦ãã ã•ã„ã€‚</p>
            <div>
                <input type="email" id="reauth-email-input" placeholder="æ—¢å­˜ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" required readonly>
                <input type="password" id="reauth-password-input" placeholder="æ—¢å­˜ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" required>
                <div class="auth-buttons">
                    <button id="reauth-login-btn">ãƒªãƒ³ã‚¯ã‚’å®Œäº†ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³</button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
