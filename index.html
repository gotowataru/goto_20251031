<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ログイン/サインアップ</title>
</head>
<body>
    <h1>Firebase認証テストページ</h1>
    <p id="user-status">認証状態をチェック中...</p>

    <div id="login-section">
        <h2>ログイン / アカウント作成</h2>
        <button id="google-login-btn">Googleでログイン</button>
        <hr>
        <div>
            <input type="email" id="email-input" placeholder="メールアドレス">
            <input type="password" id="password-input" placeholder="パスワード">
            <button id="email-signup-btn">Emailでサインアップ</button>
            <button id="email-login-btn">Emailでログイン</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        
        // あなたのウェブアプリのFirebase設定 (前回と同じ設定を仮に使用)
        const firebaseConfig = {
            apiKey: "AIzaSyDt69H-dBGMB4HANbwVj007vJ3yblEZdqE",
            authDomain: "goto6234.firebaseapp.com",
            projectId: "goto6234",
            storageBucket: "goto6234.firebasestorage.app",
            messagingSenderId: "730149609843",
            appId: "1:730149609843:web:d11237de52723fc45b2506",
            measurementId: "G-FDRB7H8MRR"
        };

        // Firebaseの初期化
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const googleProvider = new GoogleAuthProvider();

        // HTML要素への参照を取得
        const userStatusDiv = document.getElementById('user-status');
        const loginSection = document.getElementById('login-section');
        loginSection.style.display = 'none'; // 初期状態は非表示にしてチラつきを防止

        // 認証状態の監視
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // ログイン済みの場合：マイページへリダイレクト
                userStatusDiv.textContent = 'ログイン済み。マイページへ移動します...';
                window.location.href = 'mypage.html';
            } else {
                // 未ログインの場合
                userStatusDiv.textContent = '未ログイン';
                loginSection.style.display = 'block'; // フォームを表示
            }
        });

        // --- 認証イベントリスナー（前回と同じロジック） ---

        document.getElementById('google-login-btn').addEventListener('click', async () => {
            try {
                await signInWithPopup(auth, googleProvider);
                // 成功後、onAuthStateChanged が検知してリダイレクト
            } catch (error) {
                console.error("Googleログインエラー:", error);
                alert("Googleログインに失敗しました: " + error.message);
            }
        });

        document.getElementById('email-signup-btn').addEventListener('click', async () => {
            const email = document.getElementById('email-input').value;
            const password = document.getElementById('password-input').value;
            if (!email || !password) return alert('メールアドレスとパスワードを入力してください。');
            try {
                await createUserWithEmailAndPassword(auth, email, password);
                // 成功後、onAuthStateChanged が検知してリダイレクト
            } catch (error) {
                console.error("Emailサインアップエラー:", error);
                alert("Emailサインアップに失敗しました: " + error.message);
            }
        });

        document.getElementById('email-login-btn').addEventListener('click', async () => {
            const email = document.getElementById('email-input').value;
            const password = document.getElementById('password-input').value;
            if (!email || !password) return alert('メールアドレスとパスワードを入力してください。');
            try {
                await signInWithEmailAndPassword(auth, email, password);
                // 成功後、onAuthStateChanged が検知してリダイレクト
            } catch (error) {
                console.error("Emailログインエラー:", error);
                alert("Emailログインに失敗しました: " + error.message);
            }
        });
    </script>
</body>
</html>
