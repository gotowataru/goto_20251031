<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理者イベント登録ページ | 決定版</title>
    <style>
        :root { --primary: #5e35b1; --accent: #ff5252; --bg: #f8f9ff; --text: #333; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; padding: 20px; background: var(--bg); color: var(--text); }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        h1 { color: var(--primary); border-bottom: 3px solid var(--primary); padding-bottom: 10px; margin-bottom: 30px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-weight: bold; margin-bottom: 8px; color: #444; }
        .form-group input:not([type="checkbox"]):not([type="radio"]),
        .form-group select,
        .form-group textarea {
            width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 1em;
            transition: border-color 0.2s;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { border-color: var(--primary); outline: none; }
        textarea { resize: vertical; min-height: 120px; }
        .checkbox-group label { font-weight: normal; display: inline-block; margin-right: 20px; }
        .submit-btn {
            background: var(--accent); color: white; padding: 15px 30px; border: none; border-radius: 50px;
            font-size: 1.1em; font-weight: bold; cursor: pointer; transition: background 0.3s;
        }
        .submit-btn:hover { background: #d32f2f; }
        #message { margin-top: 20px; padding: 15px; border-radius: 8px; font-weight: bold; display: none; }
        .success { background: #e8f5e9; color: #388e3c; }
        .error { background: #ffebee; color: #d32f2f; }
    </style>
</head>
<body>

    <div class="container">
        <h1>イベント登録フォーム</h1>

        <form id="event-form">
            <div class="form-group">
                <label for="name">イベント名 <span style="color:var(--accent);">*</span></label>
                <input type="text" id="name" required>
            </div>

            <div class="form-group">
                <label for="date">開催日 <span style="color:var(--accent);">*</span></label>
                <input type="date" id="date" required>
            </div>
            
            <div class="form-group">
                <label for="startTime">開始時間 (例: 10:00)</label>
                <input type="time" id="startTime">
            </div>

            <div class="form-group">
                <label for="endTime">終了時間 (例: 17:00)</label>
                <input type="time" id="endTime">
            </div>

            <div class="form-group">
                <label for="category">カテゴリ <span style="color:var(--accent);">*</span></label>
                <select id="category" required>
                    <option value="">選択してください</option>
                    <option value="matsuri">祭り</option>
                    <option value="music">音楽</option>
                    <option value="learn">学び</option>
                    <option value="workshop">ワークショップ</option>
                    <option value="sports">スポーツ</option>
                    <option value="gourmet">グルメ</option>
                    <option value="exhibition">展示・芸術</option>
                </select>
            </div>

            <div class="form-group">
                <label for="venue">会場</label>
                <input type="text" id="venue">
            </div>
            
            <div class="form-group">
                <label for="organizer">主催者</label>
                <input type="text" id="organizer">
            </div>

            <div class="form-group">
                <label for="imageUrl">画像URL (トップページ一覧用)</label>
                <input type="url" id="imageUrl">
            </div>

            <div class="form-group">
                <label for="summary">要約 (一覧表示用、200文字まで)</label>
                <textarea id="summary" maxlength="200"></textarea>
            </div>

            <div class="form-group">
                <label for="description">詳細本文 (詳細ページ用)</label>
                <textarea id="description"></textarea>
            </div>

            <div class="form-group checkbox-group">
                <label><input type="checkbox" id="isFeatured"> おすすめイベントとして表示する</label>
            </div>

            <div class="form-group">
                <label for="tags">タグ (コンマ区切りで複数入力)</label>
                <input type="text" id="tags" placeholder="例: 無料,ファミリー向け,初心者歓迎">
            </div>

            <button type="submit" class="submit-btn">イベントを登録</button>
            <div id="message"></div>
        </form>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
        // setDoc, doc, getDocs, query, where をインポート
        import { getFirestore, collection, setDoc, doc, serverTimestamp, getDocs, query, where } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

        // ★★★ Firebase Config: ここは index.html と同じ設定を使用してください ★★★
        const firebaseConfig = {
            apiKey: "AIzaSyDt69H-dBGMB4HANbwVj007vJ3yblEZdqE",
            authDomain: "goto6234.firebaseapp.com",
            projectId: "goto6234",
            storageBucket: "goto6234.firebasestorage.app",
            messagingSenderId: "730149609843",
            appId: "1:730149609843:web:d11237de52723fc45b2506"
        };
        // ★★★ 

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const form = document.getElementById('event-form');
        const messageElement = document.getElementById('message');

        function showMessage(msg, type) {
            messageElement.textContent = msg;
            messageElement.className = ''; // クラスをリセット
            messageElement.classList.add(type);
            messageElement.style.display = 'block';
            setTimeout(() => {
                messageElement.style.display = 'none';
            }, 5000); // 5秒後にメッセージを消す
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // フォームデータの収集
            const eventData = {
                name: document.getElementById('name').value.trim(),
                date: document.getElementById('date').value,
                startTime: document.getElementById('startTime').value.trim(),
                endTime: document.getElementById('endTime').value.trim(),
                category: document.getElementById('category').value,
                venue: document.getElementById('venue').value.trim(),
                organizer: document.getElementById('organizer').value.trim(),
                imageUrl: document.getElementById('imageUrl').value.trim(),
                summary: document.getElementById('summary').value.trim(),
                description: document.getElementById('description').value,
                isFeatured: document.getElementById('isFeatured').checked,
                createdAt: serverTimestamp() // 登録日時
            };

            // タグの処理
            const tagsInput = document.getElementById('tags').value.trim();
            eventData.tags = tagsInput 
                ? tagsInput.split(',').map(tag => tag.trim()).filter(tag => tag.length > 0)
                : [];

            // 必須項目チェック
            if (!eventData.name || !eventData.date || !eventData.category) {
                showMessage("エラー: イベント名、開催日、カテゴリは必須です。", "error");
                return;
            }

            // --- ★★★ 修正されたカスタムID生成ロジック ★★★ ---
            const targetDate = eventData.date; // 例: '2025-11-28'
            const idPrefix = `event-${targetDate}-`; // 例: 'event-2025-11-28-'
            let maxSequence = 0;

            try {
                // 1. シンプルなクエリで、その日付の全イベントを取得
                // 「date」フィールドに対するシンプルな where 句なので、整合性が保たれやすい
                const q = query(
                    collection(db, "events"),
                    where("date", "==", targetDate) 
                );
                const snap = await getDocs(q);

                // 2. 取得した全ドキュメントIDから最大の連番を見つける
                snap.docs.forEach(doc => {
                    const id = doc.id;
                    // ドキュメントIDが正しい形式（event-YYYY-MM-DD-NNNN）であることを確認
                    if (id.startsWith(idPrefix) && id.length > idPrefix.length) {
                        // IDの末尾の連番部分を抽出
                        const seqPart = id.substring(id.lastIndexOf('-') + 1);
                        const sequence = parseInt(seqPart);
                        
                        // 有効な数値で、これまでの最大値より大きい場合、更新
                        if (!isNaN(sequence) && sequence > maxSequence) {
                            maxSequence = sequence;
                        }
                    }
                });
                
                const newSequence = maxSequence + 1;

                // 3. 新しいIDを生成（4桁ゼロ埋め）
                const sequenceStr = newSequence.toString().padStart(4, '0');
                const customId = `${idPrefix}${sequenceStr}`; 

                // 4. Firestoreへのデータ送信（setDocを使用してカスタムIDを設定）
                // setDocはIDが重複した場合、上書きします
                await setDoc(doc(db, "events", customId), eventData);
                
                showMessage(`イベントを登録しました！ (ID: ${customId})`, "success");
                form.reset(); // フォームをリセット

            } catch (e) {
                console.error("イベント登録エラー: ", e);
                showMessage(`イベント登録に失敗しました: ${e.message}`, "error");
            }
        });
    </script>
</body>
</html>
