<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>マイページ</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 30px 0; }
        .container { max-width: 1000px; margin: 0 auto; background: rgba(255,255,255,0.95); padding: 40px; border-radius: 20px; box-shadow: 0 20px 50px rgba(0,0,0,0.2); }
        h1 { color: #5e35b1; text-align: center; font-size: 2.8em; margin-bottom: 10px; }
        #user-info { background: #e8f5e8; padding: 20px; border-radius: 12px; border-left: 6px solid #43a047; margin-bottom: 30px; }
        #logout-btn { background: #ff5252; color: white; padding: 15px 30px; border: none; border-radius: 50px; font-size: 1.1em; cursor: pointer; width: 100%; margin-top: 30px; box-shadow: 0 8px 20px rgba(255,82,82,0.4); transition: all 0.3s; }
        #logout-btn:hover { transform: translateY(-3px); box-shadow: 0 12px 25px rgba(255,82,82,0.5); }

        .favorites-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 20px; margin-top: 30px; }
        .fav-card { background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 10px 25px rgba(0,0,0,0.1); transition: transform 0.3s; position: relative; }
        .fav-card:hover { transform: translateY(-8px); }
        .fav-card img { width: 100%; height: 180px; object-fit: cover; }
        .fav-content { padding: 20px; }
        .fav-title { font-size: 1.3em; margin: 0 0 10px; color: #5e35b1; }
        .remove-btn { position: absolute; top: 12px; right: 12px; background: #ff5252; color: white; border: none; width: 36px; height: 36px; border-radius: 50%; font-size: 18px; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .calendar-btn { display: inline-block; margin-top: 10px; padding: 10px 16px; background: #4285F4; color: white; text-decoration: none; border-radius: 30px; font-weight: bold; }
        .calendar-btn:hover { background: #3367d6; }
    </style>
</head>
<body>
    <div class="container">
        <h1>マイページ</h1>
        <div id="user-info">読み込み中...</div>

        <h2 style="color:#5e35b1; border-bottom:3px solid #ddd; padding-bottom:10px;">お気に入りイベント</h2>
        <div id="favorites-list" class="favorites-grid"></div>

        <button id="logout-btn">ログアウト</button>
        <p style="text-align:center; margin-top:20px;"><a href="index.html" style="color:#5e35b1; font-weight:bold;">イベント一覧に戻る</a></p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc, arrayRemove, query, where, getDocs, collection } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        const firebaseConfig = { /* 同じなので省略 */ 
            apiKey: "AIzaSyDt69H-dBGMB4HANbwVj007vJ3yblEZdqE",
            authDomain: "goto6234.firebaseapp.com",
            projectId: "goto6234",
            storageBucket: "goto6234.firebasestorage.app",
            messagingSenderId: "730149609843",
            appId: "1:730149609843:web:d11237de52723fc45b2506"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const userInfo = document.getElementById('user-info');
        const favoritesList = document.getElementById('favorites-list');
        let currentUser = null;

        const formatToCalendarDate = (date, start, end) => {
            if (!start || !end) return null;
            const s = new Date(`${date} ${start}:00`).toISOString().replace(/[-:]|\.\d{3}/g, '');
            const e = new Date(`${date} ${end}:00`).toISOString().replace(/[-:]|\.\d{3}/g, '');
            return `${s}/${e}`;
        };

        const removeFavorite = async (eventId) => {
            if (!confirm('お気に入りから解除しますか？')) return;
            await updateDoc(doc(db, 'users', currentUser.uid), { favorites: arrayRemove(eventId) });
            displayFavoriteEvents();
        };

        window.removeFavorite = removeFavorite; // グローバルに

        const displayFavoriteEvents = async () => {
            favoritesList.innerHTML = '<p style="grid-column:1/-1; text-align:center; color:#777;">読み込み中...</p>';
            const userSnap = await getDoc(doc(db, 'users', currentUser.uid));
            if (!userSnap.exists() || !userSnap.data().favorites?.length) {
                favoritesList.innerHTML = '<p style="grid-column:1/-1; text-align:center; font-size:1.3em;">まだお気に入りは登録されていません</p>';
                return;
            }

            const favIds = userSnap.data().favorites;
            const q = query(collection(db, 'events'), where('__name__', 'in', favIds.slice(0,10)));
            const snaps = await getDocs(q);

            let html = '';
            snaps.forEach(s => {
                const d = s.data();
                const dates = formatToCalendarDate(d.date, d.startTime, d.endTime);
                const calBtn = dates ? `<a href="https://www.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(d.name)}&dates=${dates}&details=${encodeURIComponent(d.description)}" target="_blank" class="calendar-btn">Googleカレンダーに追加</a>` : '';

                const img = d.imageUrl ? `<img src="${d.imageUrl}" alt="${d.name}">` : '<div style="height:180px; background:#eee; display:flex; align-items:center; justify-content:center; color:#999;">画像なし</div>';

                html += `
                    <div class="fav-card">
                        ${img}
                        <div class="fav-content">
                            <h3 class="fav-title">${d.name}</h3>
                            <p><strong>${d.date}</strong> ${d.startTime || ''} 〜 ${d.endTime || '終日'}</p>
                            <p>${d.description.substring(0,80)}...</p>
                            ${calBtn}
                            <button class="remove-btn" onclick="removeFavorite('${s.id}')">×</button>
                        </div>
                    </div>
                `;
            });
            favoritesList.innerHTML = html;
        };

        onAuthStateChanged(auth, user => {
            currentUser = user;
            if (user) {
                userInfo.innerHTML = `<strong>${user.displayName || user.email}</strong> さん、ようこそ！<br>UID: ${user.uid}`;
                displayFavoriteEvents();
            } else {
                setTimeout(() => { alert('ログインが必要です'); location.href = 'index.html'; }, 2000);
            }
        });

        document.getElementById('logout-btn').onclick = async () => {
            await signOut(auth);
            location.href = 'index.html?logout=success';
        };
    </script>
</body>
</html>
