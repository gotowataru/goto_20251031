<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒã‚¤ãƒšãƒ¼ã‚¸</title>
    <style>
        body { font-family: sans-serif; margin: 30px; background-color: #e6f7ff; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 25px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h1 { color: #1e88e5; text-align: center; }
        h2 { border-bottom: 2px solid #bbdefb; padding-bottom: 5px; margin-top: 30px; color: #1e88e5; }
        #user-info { 
            padding: 15px; 
            border: 1px solid #bbdefb; 
            border-left: 5px solid #1e88e5; 
            background-color: #f0f8ff; 
            border-radius: 4px; 
            margin-top: 20px;
            word-break: break-all;
            min-height: 50px;
        }
        #logout-btn { 
            display: block;
            width: 100%;
            padding: 12px 15px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            background-color: #f44336; 
            color: white; 
            margin-top: 30px; 
            font-weight: bold;
            transition: background-color 0.3s;
        }
        #logout-btn:hover { background-color: #d32f2f; }
        
        /* ãŠæ°—ã«å…¥ã‚Šãƒªã‚¹ãƒˆã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #favorites-list ul {
            list-style: none;
            padding: 0;
        }
        #favorites-list li {
            padding: 10px 0;
            border-bottom: 1px dashed #eee;
        }
        #favorites-list li:last-child {
            border-bottom: none;
        }
        #favorites-list strong {
            color: #333;
            font-size: 16px;
        }
        #favorites-list small {
            display: block;
            color: #777;
        }
    </style>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js"; // â˜… Firestoreé–¢é€£ã‚’è¿½åŠ 

        // ã‚ãªãŸã®ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã®Firebaseè¨­å®š (index.htmlã¨å…±é€š)
        const firebaseConfig = {
            apiKey: "AIzaSyDt69H-dBGMB4HANbwVj007vJ3yblEZdqE",
            authDomain: "goto6234.firebaseapp.com",
            projectId: "goto6234",
            storageBucket: "goto6234.firebasestorage.app",
            messagingSenderId: "730149609843",
            appId: "1:730149609843:web:d11237de52723fc45b2506",
            measurementId: "G-FDRB7H8MRR"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app); // â˜… Firestoreã®åˆæœŸåŒ–

        const userInfoElement = document.getElementById('user-info');
        const logoutButton = document.getElementById('logout-btn');
        const favoritesListElement = document.getElementById('favorites-list');

        // --- Firestore ãƒ‡ãƒ¼ã‚¿å‡¦ç† ---

        /**
         * ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãŠæ°—ã«å…¥ã‚Šã‚¤ãƒ™ãƒ³ãƒˆã‚’å–å¾—ã—ã€è¡¨ç¤ºã™ã‚‹
         */
        const displayFavoriteEvents = async (user) => {
            favoritesListElement.innerHTML = 'ãŠæ°—ã«å…¥ã‚Šã‚¤ãƒ™ãƒ³ãƒˆã‚’èª­ã¿è¾¼ã¿ä¸­...';
            
            try {
                // 1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®favoritesé…åˆ—ã‚’å–å¾—
                const userRef = doc(db, 'users', user.uid);
                const userSnap = await getDoc(userRef);

                if (!userSnap.exists() || !userSnap.data().favorites || userSnap.data().favorites.length === 0) {
                    favoritesListElement.innerHTML = '<p>ã¾ã ãŠæ°—ã«å…¥ã‚Šã«ç™»éŒ²ã—ãŸã‚¤ãƒ™ãƒ³ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§ã‹ã‚‰è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</p>';
                    return;
                }

                const favoriteEventIds = userSnap.data().favorites;

                // 2. favoritesé…åˆ—ã«å«ã¾ã‚Œã‚‹IDã®ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±ã‚’ã¾ã¨ã‚ã¦å–å¾—
                const eventsRef = collection(db, 'events');
                // where('__name__', 'in', ...) ã‚’ä½¿ç”¨ã—ã¦ã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆIDãŒãƒªã‚¹ãƒˆã«å«ã¾ã‚Œã‚‹ã‚‚ã®ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
                const q = query(eventsRef, where('__name__', 'in', favoriteEventIds)); 
                const eventSnaps = await getDocs(q);

                let html = '<ul>';
                if (eventSnaps.empty) {
                    html = '<p>ãŠæ°—ã«å…¥ã‚Šã«ç™»éŒ²ã•ã‚Œã¦ã„ãŸã‚¤ãƒ™ãƒ³ãƒˆãŒç¾åœ¨è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚</p>';
                } else {
                    eventSnaps.forEach(eventDoc => {
                        const eventData = eventDoc.data();
                        html += `
                            <li>
                                <strong>${eventData.name}</strong> (${eventData.date})<br>
                                <small>${eventData.description}</small>
                            </li>
                        `;
                    });
                    html += '</ul>';
                }
                
                favoritesListElement.innerHTML = html;

            } catch (error) {
                console.error("ãŠæ°—ã«å…¥ã‚Šã‚¤ãƒ™ãƒ³ãƒˆã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", error);
                favoritesListElement.innerHTML = '<p>ãŠæ°—ã«å…¥ã‚Šã‚¤ãƒ™ãƒ³ãƒˆã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚</p>';
            }
        };

        // --- èªè¨¼çŠ¶æ…‹ã®ç›£è¦– ---

        onAuthStateChanged(auth, (user) => {
            if (user) {
                // ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã®å ´åˆã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’è¡¨ç¤º
                userInfoElement.innerHTML = `
                    <strong>âœ… ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±</strong><br>
                    <strong>è¡¨ç¤ºå/Email:</strong> ${user.displayName || user.email}<br>
                    <strong>UID:</strong> ${user.uid}<br>
                    <strong>ãƒ—ãƒ­ãƒã‚¤ãƒ€:</strong> ${user.providerData[0] ? user.providerData[0].providerId : 'Email/Password'}
                `;
                
                // ãŠæ°—ã«å…¥ã‚Šã‚¤ãƒ™ãƒ³ãƒˆã®è¡¨ç¤ºã‚’ã‚­ãƒƒã‚¯
                displayFavoriteEvents(user);

            } else {
                // æœªãƒ­ã‚°ã‚¤ãƒ³ãŒç¢ºå®šã—ãŸå ´åˆã®å‡¦ç†
                userInfoElement.innerHTML = `
                    <strong>ğŸš« æœªãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚’æ¤œå‡ºã—ã¾ã—ãŸã€‚</strong><br>
                    ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã¸è‡ªå‹•çš„ã«æˆ»ã‚Šã¾ã™...
                `;
                
                // 3ç§’å¾Œã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã‚’å®Ÿè¡Œ
                setTimeout(() => {
                    alert("æœªãƒ­ã‚°ã‚¤ãƒ³ã§ã™ã€‚ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã¸æˆ»ã‚Šã¾ã™ã€‚");
                    window.location.href = 'index.html'; 
                }, 3000); 
            }
        });

        // --- ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç† ---
        logoutButton.addEventListener('click', async () => {
            try {
                await signOut(auth);
                alert("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚");
                window.location.href = 'logout.html'; // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå¾Œã€logout.htmlã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
            } catch (error) {
                console.error("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼:", error);
                alert("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: " + error.message);
            }
        });
    </script>
</head>
<body>
    <div class="container">
        <h1>ã‚ˆã†ã“ãã€ãƒã‚¤ãƒšãƒ¼ã‚¸ã¸ï¼ğŸ‰</h1>
        <p id="user-info">ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’ç¢ºèªä¸­ã§ã™...</p>

        <hr>
        
        <h2>â¤ï¸ ãŠæ°—ã«å…¥ã‚Šã‚¤ãƒ™ãƒ³ãƒˆ</h2>
        <div id="favorites-list">
            </div>

        <button id="logout-btn">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        <p style="text-align: center; margin-top: 15px;"><a href="index.html">ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§ã«æˆ»ã‚‹</a></p>
    </div>
</body>
</html>
