<!--mypage.html -->
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒã‚¤ãƒšãƒ¼ã‚¸</title>
    <style>
        body { font-family: sans-serif; margin: 30px; background-color: #e6f7ff; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 25px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h1 { color: #1e88e5; text-align: center; }
        h2 { border-bottom: 2px solid #bbdefb; padding-bottom: 5px; margin-top: 30px; color: #1e88e5; }
        #user-info { 
            padding: 15px; 
            border: 1px solid #bbdefb; 
            border-left: 5px solid #1e88e5; 
            background-color: #f0f8ff; 
            border-radius: 4px; 
            margin-top: 20px;
            word-break: break-all;
            min-height: 50px;
        }
        #logout-btn { 
            display: block;
            width: 100%;
            padding: 12px 15px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            background-color: #f44336; 
            color: white; 
            margin-top: 30px; 
            font-weight: bold;
            transition: background-color 0.3s;
        }
        #logout-btn:hover { background-color: #d32f2f; }
        
        /* ãŠæ°—ã«å…¥ã‚Šãƒªã‚¹ãƒˆã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #favorites-list ul {
            list-style: none;
            padding: 0;
        }
        #favorites-list li {
            padding: 10px 0;
            border-bottom: 1px dashed #eee;
        }
        #favorites-list li:last-child {
            border-bottom: none;
        }
        #favorites-list strong {
            color: #333;
            font-size: 16px;
        }
        #favorites-list small {
            display: block;
            color: #777;
        }

        /* â˜… Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’è¿½åŠ  â˜… */
        .calendar-btn {
            display: inline-block;
            margin-top: 8px;
            padding: 6px 10px;
            background-color: #4285F4; /* Google Blue */
            color: white;
            text-decoration: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: bold;
            transition: background-color 0.2s;
        }

        .calendar-btn:hover {
            background-color: #3367d6;
        }
    </style>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        // ã‚ãªãŸã®ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã®Firebaseè¨­å®š (index.htmlã¨å…±é€š)
        const firebaseConfig = {
            apiKey: "AIzaSyDt69H-dBGMB4HANbwVj007vJ3yblEZdqE",
            authDomain: "goto6234.firebaseapp.com",
            projectId: "goto6234",
            storageBucket: "goto6234.firebasestorage.app",
            messagingSenderId: "730149609843",
            appId: "1:730149609843:web:d11237de52723fc45b2506",
            measurementId: "G-FDRB7H8MRR"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const userInfoElement = document.getElementById('user-info');
        const logoutButton = document.getElementById('logout-btn');
        const favoritesListElement = document.getElementById('favorites-list');

        // --- â˜… Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç”¨ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° â˜… ---

        /**
         * æ—¥ä»˜ã¨æ™‚åˆ»æ–‡å­—åˆ—ã‚’Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç”¨UTCå½¢å¼ã«å¤‰æ›ã™ã‚‹ã€‚
         * @param {string} dateString - æ—¥ä»˜ (ä¾‹: 2025/12/25)
         * @param {string} startTime - é–‹å§‹æ™‚åˆ» (ä¾‹: 10:00)
         * @param {string} endTime - çµ‚äº†æ™‚åˆ» (ä¾‹: 18:00)
         * @returns {string} - UTCå½¢å¼ã®æœŸé–“æ–‡å­—åˆ— (ä¾‹: 20251225T010000Z/20251225T090000Z)
         */
        const formatToCalendarDate = (dateString, startTime, endTime) => {
            if (!dateString || !startTime || !endTime) {
                // æ™‚åˆ»æƒ…å ±ãŒãªã„å ´åˆã¯ã€çµ‚æ—¥ã‚¤ãƒ™ãƒ³ãƒˆã¨ã—ã¦å‡¦ç†ã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã ãŒã€ä»Šå›ã¯æ™‚åˆ»å¿…é ˆã¨ã™ã‚‹
                return null;
            }

            // æ—¥ä»˜ã¨æ™‚åˆ»ã‚’çµåˆã—ã¦Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ (æ—¥æœ¬æ™‚é–“ JSTã¨ã—ã¦æ‰±ã†)
            const startDateTimeStr = `${dateString} ${startTime}:00`;
            const endDateTimeStr = `${dateString} ${endTime}:00`;
            
            // new Date() ãŒ JST (UTC+9) ã¨ã—ã¦è§£é‡ˆã™ã‚‹
            const startDate = new Date(startDateTimeStr);
            const endDate = new Date(endDateTimeStr);

            // UTCå½¢å¼ (YYYYMMDDTHHMMSSZ) ã«å¤‰æ›ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼
            const format = (d) => {
                // ISOæ–‡å­—åˆ—ã‹ã‚‰ãƒã‚¤ãƒ•ãƒ³ã€ã‚³ãƒ­ãƒ³ã€ãƒŸãƒªç§’ã‚’å‰Šé™¤ã—ã€Z(UTC)ã‚’ä»˜ä¸
                // JSTã§ä½œæˆã—ãŸDateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’toISOString()ã§UTCã«å¤‰æ›
                return d.toISOString().replace(/[-:]|\.\d{3}/g, '');
            };
            
            // JSTã§ä½œæˆã—ãŸæ™‚åˆ»ãŒtoISOString()ã§UTCã«å¤‰æ›ã•ã‚Œã‚‹ãŸã‚ã€
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯æ—¥æœ¬ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã§æ­£ã—ã„æ™‚åˆ»ã«è¦‹ãˆã‚‹ã¯ãš
            return `${format(startDate)}/${format(endDate)}`;
        };

        // --- Firestore ãƒ‡ãƒ¼ã‚¿å‡¦ç† ---

        /**
         * ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãŠæ°—ã«å…¥ã‚Šã‚¤ãƒ™ãƒ³ãƒˆã‚’å–å¾—ã—ã€è¡¨ç¤ºã™ã‚‹
         */
        const displayFavoriteEvents = async (user) => {
            favoritesListElement.innerHTML = 'ãŠæ°—ã«å…¥ã‚Šã‚¤ãƒ™ãƒ³ãƒˆã‚’èª­ã¿è¾¼ã¿ä¸­...';
            
            try {
                // 1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®favoritesé…åˆ—ã‚’å–å¾—
                const userRef = doc(db, 'users', user.uid);
                const userSnap = await getDoc(userRef);

                if (!userSnap.exists() || !userSnap.data().favorites || userSnap.data().favorites.length === 0) {
                    favoritesListElement.innerHTML = '<p>ã¾ã ãŠæ°—ã«å…¥ã‚Šã«ç™»éŒ²ã—ãŸã‚¤ãƒ™ãƒ³ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§ã‹ã‚‰è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</p>';
                    return;
                }

                const favoriteEventIds = userSnap.data().favorites;

                // 2. favoritesé…åˆ—ã«å«ã¾ã‚Œã‚‹IDã®ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±ã‚’ã¾ã¨ã‚ã¦å–å¾— (IDãŒ10å€‹ä»¥ä¸‹ã§ã‚ã‚‹ã“ã¨ã‚’å‰æ)
                const eventsRef = collection(db, 'events');
                const q = query(eventsRef, where('__name__', 'in', favoriteEventIds)); 
                const eventSnaps = await getDocs(q);

                let html = '<ul>';
                if (eventSnaps.empty) {
                    html = '<p>ãŠæ°—ã«å…¥ã‚Šã«ç™»éŒ²ã•ã‚Œã¦ã„ãŸã‚¤ãƒ™ãƒ³ãƒˆãŒç¾åœ¨è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚</p>';
                } else {
                    eventSnaps.forEach(eventDoc => {
                        const eventData = eventDoc.data();
                        
                        const timeDisplay = (eventData.startTime && eventData.endTime) 
                                            ? `${eventData.startTime} ã€œ ${eventData.endTime}` 
                                            : 'ï¼ˆæ™‚åˆ»æƒ…å ±ãªã—ï¼‰';

                        // â˜… ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼URLç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ â˜…
                        const dates = formatToCalendarDate(eventData.date, eventData.startTime, eventData.endTime);
                        let calUrl = '#';
                        let calendarButtonHtml = '<span style="color:red; font-size: 14px;">æ™‚åˆ»æƒ…å ±ä¸è¶³</span>';

                        if (dates) {
                            // URLã‚’ä½œæˆã—ã€å„ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰
                            calUrl = `https://www.google.com/calendar/render?action=TEMPLATE&` +
                                     `text=${encodeURIComponent(eventData.name)}&` +
                                     `dates=${dates}&` +
                                     `details=${encodeURIComponent(eventData.description + '\n\nè©³ç´°URLã¯ index.html ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚')}&` +
                                     `sf=true&output=xml`;
                            
                            calendarButtonHtml = `<a href="${calUrl}" target="_blank" class="calendar-btn">ğŸ—“ï¸ Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã¸è¿½åŠ </a>`;
                        }

                        html += `
                            <li>
                                <strong>${eventData.name}</strong> (${eventData.date}) - ${timeDisplay}<br>
                                <small>${eventData.description}</small>
                                <br>
                                ${calendarButtonHtml} </li>
                        `;
                    });
                    html += '</ul>';
                }
                
                favoritesListElement.innerHTML = html;

            } catch (error) {
                console.error("ãŠæ°—ã«å…¥ã‚Šã‚¤ãƒ™ãƒ³ãƒˆã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", error);
                favoritesListElement.innerHTML = '<p>ãŠæ°—ã«å…¥ã‚Šã‚¤ãƒ™ãƒ³ãƒˆã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚</p>';
            }
        };

        // --- èªè¨¼çŠ¶æ…‹ã®ç›£è¦– ---

        onAuthStateChanged(auth, (user) => {
            if (user) {
                // ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã®å ´åˆã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’è¡¨ç¤º
                userInfoElement.innerHTML = `
                    <strong>âœ… ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±</strong><br>
                    <strong>è¡¨ç¤ºå/Email:</strong> ${user.displayName || user.email}<br>
                    <strong>UID:</strong> ${user.uid}<br>
                    <strong>ãƒ—ãƒ­ãƒã‚¤ãƒ€:</strong> ${user.providerData[0] ? user.providerData[0].providerId : 'Email/Password'}
                `;
                
                // ãŠæ°—ã«å…¥ã‚Šã‚¤ãƒ™ãƒ³ãƒˆã®è¡¨ç¤ºã‚’ã‚­ãƒƒã‚¯
                displayFavoriteEvents(user);

            } else {
                // æœªãƒ­ã‚°ã‚¤ãƒ³ãŒç¢ºå®šã—ãŸå ´åˆã®å‡¦ç†
                userInfoElement.innerHTML = `
                    <strong>ğŸš« æœªãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚’æ¤œå‡ºã—ã¾ã—ãŸã€‚</strong><br>
                    ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã¸è‡ªå‹•çš„ã«æˆ»ã‚Šã¾ã™...
                `;
                
                // 3ç§’å¾Œã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã‚’å®Ÿè¡Œ
                setTimeout(() => {
                    alert("æœªãƒ­ã‚°ã‚¤ãƒ³ã§ã™ã€‚ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã¸æˆ»ã‚Šã¾ã™ã€‚");
                    window.location.href = 'index.html'; 
                }, 3000); 
            }
        });

        // --- ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç† ---
        logoutButton.addEventListener('click', async () => {
            try {
                await signOut(auth);
                alert("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚");
                window.location.href = 'logout.html'; // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå¾Œã€logout.htmlã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
            } catch (error) {
                console.error("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼:", error);
                alert("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: " + error.message);
            }
        });
    </script>
</head>
<body>
    <div class="container">
        <h1>ã‚ˆã†ã“ãã€ãƒã‚¤ãƒšãƒ¼ã‚¸ã¸ï¼ğŸ‰</h1>
        <p id="user-info">ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’ç¢ºèªä¸­ã§ã™...</p>

        <hr>
        
        <h2>â¤ï¸ ãŠæ°—ã«å…¥ã‚Šã‚¤ãƒ™ãƒ³ãƒˆ</h2>
        <div id="favorites-list">
        </div>

        <button id="logout-btn">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        <p style="text-align: center; margin-top: 15px;"><a href="index.html">ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§ã«æˆ»ã‚‹</a></p>
    </div>
</body>
</html>
