<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¤ãƒ™ãƒ³ãƒˆç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
    <style>
        /* æ—¢å­˜ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’å®Œå…¨ã«ç¶­æŒ */
        :root { 
            --primary: #5e35b1; 
            --accent: #ff5252; 
            --success: #43a047; 
            --info: #4285F4; 
            --warning: #ffb300; 
            --pending: var(--info);
            --approved: var(--success);
            --rejected: var(--accent);
        }
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7fa; padding: 20px; color: #333; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 40px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        h1 { color: var(--primary); text-align: center; margin-bottom: 30px; font-size: 2.5em; border-bottom: 3px solid #eee; padding-bottom: 15px;}
        
        /* ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚¿ãƒ– */
        #filter-tabs { text-align: center; margin-bottom: 30px; }
        .status-tab {
            padding: 10px 20px; margin: 0 5px; border: 2px solid #ddd; border-radius: 25px; 
            background: white; cursor: pointer; transition: all 0.2s; font-weight: bold;
        }
        .status-tab.active { color: white; border-color: var(--primary); background: var(--primary); }
        .status-tab:hover:not(.active) { background: #f0f0f0; }

        /* ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒˆ */
        #events-list { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
            gap: 20px; 
        }
        .event-card { 
            background: #fff; 
            border-radius: 12px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); 
            padding: 20px; 
            position: relative;
            border-left: 5px solid; 
        }
        .event-card[data-status="pending"] { border-left-color: var(--pending); }
        .event-card[data-status="approved"] { border-left-color: var(--approved); }
        .event-card[data-status="rejected"] { border-left-color: var(--rejected); }
        
        .card-title { font-size: 1.4em; margin-top: 0; color: var(--primary); }
        .card-meta { font-size: 0.9em; color: #777; margin-bottom: 10px;}
        .card-meta strong { font-weight: bold; color: #555; }
        .card-status { font-weight: bold; color: var(--pending); }

        /* ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ */
        .card-actions { margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;}
        .action-btn { 
            padding: 8px 15px; border: none; border-radius: 6px; cursor: pointer; color: white; font-weight: bold; 
            transition: opacity 0.2s;
        }
        .action-btn:hover { opacity: 0.8; }
        .btn-approve { background: var(--approved); }
        .btn-reject { background: var(--rejected); }
        .btn-edit { background: var(--primary); }
        .btn-notify { background: var(--info); }
        
        /* AIç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«è¿½åŠ  */
        .ai-admin-panel {
            background: #e3f2fd; padding: 20px; border-radius: 12px; margin-bottom: 30px; 
            border: 1px solid var(--info); display: flex; flex-direction: column; gap: 10px;
        }
        .ai-status-row { display: flex; align-items: center; gap: 15px; flex-wrap: wrap; }
        #ai-status-log { font-size: 0.85em; color: #666; font-family: monospace; }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal { display: none; position: fixed; z-index: 1000; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(5px); overflow-y: auto; padding: 20px 0;}
        .modal-content { 
            background: white; margin: 5% auto; padding: 30px; border-radius: 12px; width: 90%; max-width: 800px; 
            box-shadow: 0 15px 40px rgba(0,0,0,0.5); position: relative;
        }
        .modal-close { position: absolute; top: 10px; right: 25px; font-size: 30px; font-weight: bold; cursor: pointer; color: #aaa; }
        .modal-close:hover { color: #333; }
        
        label { display: block; margin-top: 15px; margin-bottom: 5px; font-weight: bold; color: #555; }
        input[type="text"], input[type="date"], input[type="time"], input[type="number"], textarea, select {
            width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box;
        }
        .admin-fields { border-left: 5px solid var(--warning); padding-left: 15px; background: #fffde7; margin-top: 15px; padding-top: 5px; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ã‚¤ãƒ™ãƒ³ãƒˆç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
        
        <div class="ai-admin-panel">
            <h3 style="margin: 0; color: var(--info);">ğŸ¤– AIãŠã™ã™ã‚ã‚¨ãƒ³ã‚¸ãƒ³ç®¡ç†</h3>
            <p style="font-size: 0.9em; margin: 5px 0; color: #555;">ã‚¤ãƒ™ãƒ³ãƒˆã®æƒ…å ±ã‚’æ•°å€¤åŒ–ã—ã¦AIãŒãŠã™ã™ã‚ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚ï¼ˆæœªå‡¦ç†ã®ã‚¤ãƒ™ãƒ³ãƒˆã®ã¿å®Ÿè¡Œï¼‰</p>
            <div class="ai-status-row">
                <button id="btn-sync-ai" class="action-btn btn-notify">AIä¸€æ‹¬æ•°å€¤åŒ–ã‚’å®Ÿè¡Œ</button>
                <div id="ai-status-log">å¾…æ©Ÿä¸­...</div>
            </div>
        </div>

        <p style="text-align:center; color: var(--primary);">ç¾åœ¨ <span id="event-count">0</span> ä»¶ã®ã‚¤ãƒ™ãƒ³ãƒˆãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€‚</p>

        <div id="filter-tabs">
            <button class="status-tab active" data-filter="all">å…¨ã¦</button>
            <button class="status-tab" data-filter="pending">ç”³è«‹ä¸­</button>
            <button class="status-tab" data-filter="approved">æ‰¿èªæ¸ˆã¿</button>
            <button class="status-tab" data-filter="rejected">å´ä¸‹</button>
        </div>

        <div id="events-list">
            <p style="grid-column:1/-1; text-align:center; color:#777;">ã‚¤ãƒ™ãƒ³ãƒˆã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
        </div>

        <p style="text-align:center; margin-top:30px;"><a href="index.html" style="color:var(--primary); font-weight:bold;">ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§ã«æˆ»ã‚‹</a></p>
    </div>

    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close">&times;</span>
            <h2>ã‚¤ãƒ™ãƒ³ãƒˆç·¨é›† <span id="editing-event-name"></span></h2>
            <form id="edit-form">
                <div class="admin-fields">
                    <h3>ã‚¤ãƒ™ãƒ³ãƒˆæ‰¿èªæƒ…å ±</h3>
                    <div class="grid-3">
                        <div>
                            <label for="modal-status">æ‰¿èªã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
                            <select id="modal-status"></select>
                        </div>
                        <div>
                            <label for="modal-submittedBy">ç™»éŒ²è€…UID</label>
                            <input type="text" id="modal-submittedBy" readonly>
                        </div>
                        <div>
                            <label for="modal-approvedAt">æ‰¿èªæ—¥æ™‚</label>
                            <input type="text" id="modal-approvedAt" readonly>
                        </div>
                    </div>
                    <label for="modal-adminNotes">ç®¡ç†è€…ãƒ¡ãƒ¢ / å´ä¸‹ç†ç”±</label>
                    <textarea id="modal-adminNotes" placeholder="å´ä¸‹æ™‚ã®ç†ç”±ãªã©ã‚’è¨˜å…¥ã—ã¾ã™ã€‚"></textarea>
                </div>
                <hr>
                <h3>åŸºæœ¬æƒ…å ±</h3>
                <label for="modal-name">ã‚¤ãƒ™ãƒ³ãƒˆå</label>
                <input type="text" id="modal-name" required>
                <label for="modal-summary">æ¦‚è¦</label>
                <textarea id="modal-summary"></textarea>
                <div class="grid-2">
                    <div>
                        <label for="modal-date">é–‹å‚¬æ—¥</label>
                        <input type="date" id="modal-date">
                    </div>
                    <div>
                        <label for="modal-category">ã‚«ãƒ†ã‚´ãƒª</label>
                        <select id="modal-category"></select>
                    </div>
                </div>
                <label for="modal-venue">é–‹å‚¬å ´æ‰€</label>
                <input type="text" id="modal-venue">
                <h3>ã‚³ãƒ¼ã‚¹æƒ…å ±</h3>
                <div id="modal-courses-container"></div>
                <button type="submit" class="action-btn" style="background: var(--success); width: 100%; margin-top: 20px;">å¤‰æ›´ã‚’ä¿å­˜</button>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
        import { getFirestore, collection, query, getDocs, updateDoc, doc, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDt69H-dBGMB4HANbwVj007vJ3yblEZdqE",
            authDomain: "goto6234.firebaseapp.com",
            projectId: "goto6234",
            storageBucket: "goto6234.firebaseapp.com",
            messagingSenderId: "730149609843",
            appId: "1:730149609843:web:d11237de52723fc45b2506"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- è¨­å®š ---
        const WORKER_URL = "https://geminiapi.nattofromtheworld.workers.dev";

        const eventsList = document.getElementById('events-list');
        const eventCount = document.getElementById('event-count');
        const modal = document.getElementById('edit-modal');
        const modalForm = document.getElementById('edit-form');
        const modalCoursesContainer = document.getElementById('modal-courses-container');
        const modalStatusSelect = document.getElementById('modal-status');
        
        let allEvents = [];
        let currentFilter = 'all'; // ç®¡ç†ç”»é¢ã®åˆ©ä¾¿æ€§ã®ãŸã‚åˆæœŸå€¤ã‚’'all'ã«å¤‰æ›´
        let editingEventId = null;

        const STATUS_MAP = { pending: 'ç”³è«‹ä¸­', approved: 'æ‰¿èªæ¸ˆã¿', rejected: 'å´ä¸‹' };
        const CATEGORY_OPTIONS = [
            { value: 'matsuri', label: 'ç¥­ã‚Š' }, { value: 'music', label: 'éŸ³æ¥½' },
            { value: 'learn', label: 'å­¦ã³' }, { value: 'workshop', label: 'ãƒ¯ãƒ¼ã‚¯ã‚·ãƒ§ãƒƒãƒ—' },
            { value: 'sports', label: 'ã‚¹ãƒãƒ¼ãƒ„' }, { value: 'gourmet', label: 'ã‚°ãƒ«ãƒ¡' },
            { value: 'exhibition', label: 'å±•ç¤ºãƒ»èŠ¸è¡“' }
        ];

        // --- 1. ãƒ‡ãƒ¼ã‚¿å–å¾—ã¨æç”» ---

        const fetchAllEvents = async () => {
            eventsList.innerHTML = '<p style="grid-column:1/-1; text-align:center; color:var(--primary);">ã‚¤ãƒ™ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...</p>';
            try {
                const q = query(collection(db, 'events'));
                const snap = await getDocs(q);
                allEvents = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderEvents(currentFilter);
            } catch (error) {
                console.error("Error fetching events:", error);
                eventsList.innerHTML = '<p style="grid-column:1/-1; text-align:center; color:var(--accent);">ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>';
            }
        };

        const renderEvents = (filterStatus) => {
            const filtered = allEvents.filter(e => filterStatus === 'all' || (e.status || 'pending') === filterStatus);
            eventCount.textContent = allEvents.length;
            eventsList.innerHTML = '';

            if (filtered.length === 0) {
                eventsList.innerHTML = `<p style="grid-column:1/-1; text-align:center; font-size:1.2em;">è©²å½“ã™ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>`;
                return;
            }

            filtered.forEach(event => {
                const status = event.status || 'pending';
                const hasEmbedding = event.embedding ? 'âœ…' : 'âŒ';
                
                let actions = '';
                if (status === 'pending') {
                    actions += `<button class="action-btn btn-approve" onclick="updateStatus('${event.id}', 'approved')">æ‰¿èª</button>`;
                    actions += `<button class="action-btn btn-reject" onclick="openEditModal('${event.id}', 'rejected')">å´ä¸‹</button>`;
                } else if (status === 'approved') {
                    actions += `<button class="action-btn btn-reject" onclick="updateStatus('${event.id}', 'rejected')">å´ä¸‹ã«æˆ»ã™</button>`;
                } else if (status === 'rejected') {
                    actions += `<button class="action-btn btn-approve" onclick="updateStatus('${event.id}', 'approved')">æ‰¿èªã«å¤‰æ›´</button>`;
                }
                actions += `<button class="action-btn btn-edit" onclick="openEditModal('${event.id}')">ç·¨é›†</button>`;

                eventsList.innerHTML += `
                    <div class="event-card" data-status="${status}">
                        <h3 class="card-title">${event.name}</h3>
                        <div class="card-meta">
                            <p><strong>AIæ•°å€¤åŒ–:</strong> ${hasEmbedding}</p>
                            <p><strong>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:</strong> <span class="card-status" style="color:var(--${status});">${STATUS_MAP[status]}</span></p>
                            <p><strong>ç™»éŒ²è€…:</strong> ${event.submittedBy?.substring(0,8)}...</p>
                            <p><strong>é–‹å‚¬æ—¥:</strong> ${event.date || 'æœªå®š'}</p>
                        </div>
                        <div class="card-actions">${actions}</div>
                    </div>
                `;
            });
        };

        // --- [è¿½åŠ ] AIä¸€æ‹¬æ•°å€¤åŒ–ãƒ­ã‚¸ãƒƒã‚¯ ---
        const syncAIEmbeddings = async () => {
            const btn = document.getElementById('btn-sync-ai');
            const log = document.getElementById('ai-status-log');
            
            const targets = allEvents.filter(e => !e.embedding);
            
            if (targets.length === 0) {
                alert("æœªå‡¦ç†ã®ã‚¤ãƒ™ãƒ³ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ã™ã¹ã¦æ•°å€¤åŒ–æ¸ˆã¿ã§ã™ã€‚");
                return;
            }

            if (!confirm(`${targets.length} ä»¶ã‚’æ•°å€¤åŒ–ã—ã¾ã™ã‹ï¼Ÿ`)) return;

            btn.disabled = true;
            btn.style.opacity = "0.5";
            let successCount = 0;

            for (const event of targets) {
                try {
                    log.textContent = `å‡¦ç†ä¸­: ${event.name}`;
                    const textToEmbed = `${event.name} ${event.summary || ""} ${event.category || ""}`;

const response = await fetch(WORKER_URL, {
    method: "POST",
    headers: { 
        "Content-Type": "application/json",
        "Accept": "application/json" 
    },
    body: JSON.stringify({ task: "embedding", text: textToEmbed })
});

                    const result = await response.json();
                    const embeddingValues = result.embedding?.values;

                    if (embeddingValues) {
                        await updateDoc(doc(db, 'events', event.id), {
                            embedding: embeddingValues,
                            embeddingUpdatedAt: serverTimestamp()
                        });
                        successCount++;
                    }
                    await new Promise(r => setTimeout(r, 12000));
                } catch (e) {
                    console.error(e);
                    log.textContent = `âŒ ã‚¨ãƒ©ãƒ¼: ${event.name}`;
                    break;
                }
            }

            btn.disabled = false;
            btn.style.opacity = "1";
            log.textContent = `âœ… å®Œäº†: ${successCount} ä»¶ã‚’æ•°å€¤åŒ–ã—ã¾ã—ãŸã€‚`;
            fetchAllEvents();
        };
        document.getElementById('btn-sync-ai').addEventListener('click', syncAIEmbeddings);

        // --- 2. ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´ ---
        window.updateStatus = async (eventId, newStatus) => {
            if (!confirm(`ã€Œ${STATUS_MAP[newStatus]}ã€ã«å¤‰æ›´ã—ã¾ã™ã‹ï¼Ÿ`)) return;
            try {
                const updateData = { status: newStatus };
                if (newStatus === 'approved') updateData.approvedAt = serverTimestamp();
                await updateDoc(doc(db, 'events', eventId), updateData);
                fetchAllEvents();
            } catch (e) { alert('æ›´æ–°å¤±æ•—'); }
        };

        // --- 3. ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« ---
        window.openEditModal = (eventId, initialStatus = null) => {
            const event = allEvents.find(e => e.id === eventId);
            if (!event) return;
            editingEventId = eventId;
            document.getElementById('editing-event-name').textContent = ` - ${event.name}`;
            
            modalStatusSelect.innerHTML = Object.entries(STATUS_MAP).map(([v, l]) => `<option value="${v}">${l}</option>`).join('');
            document.getElementById('modal-category').innerHTML = CATEGORY_OPTIONS.map(c => `<option value="${c.value}">${c.label}</option>`).join('');
            
            document.getElementById('modal-name').value = event.name || '';
            document.getElementById('modal-summary').value = event.summary || '';
            document.getElementById('modal-date').value = event.date || '';
            document.getElementById('modal-category').value = event.category || '';
            document.getElementById('modal-venue').value = event.venue || '';
            document.getElementById('modal-status').value = initialStatus || event.status || 'pending';
            document.getElementById('modal-submittedBy').value = event.submittedBy || 'N/A';
            document.getElementById('modal-adminNotes').value = event.adminNotes || '';
            document.getElementById('modal-approvedAt').value = event.approvedAt ? event.approvedAt.toDate().toLocaleString() : 'æœªæ‰¿èª';
            
            modalCoursesContainer.innerHTML = (event.courses || []).map(c => `
                <div style="border:1px dashed #ccc; padding:10px; margin-bottom:10px;">
                    <strong>${c.courseName}</strong> (${c.price}å††)
                </div>
            `).join('') || '<p>ã‚³ãƒ¼ã‚¹æƒ…å ±ãªã—</p>';
            modal.style.display = 'block';
        };

        modalForm.onsubmit = async (e) => {
            e.preventDefault();
            const newStatus = document.getElementById('modal-status').value;
            const updateData = {
                name: document.getElementById('modal-name').value,
                summary: document.getElementById('modal-summary').value,
                date: document.getElementById('modal-date').value,
                category: document.getElementById('modal-category').value,
                venue: document.getElementById('modal-venue').value,
                status: newStatus,
                adminNotes: document.getElementById('modal-adminNotes').value,
            };
            try {
                await updateDoc(doc(db, 'events', editingEventId), updateData);
                modal.style.display = 'none';
                fetchAllEvents();
            } catch (e) { alert('ä¿å­˜å¤±æ•—'); }
        };

        // --- 4. åˆæœŸåŒ– ---
        document.querySelectorAll('.status-tab').forEach(tab => {
            tab.onclick = (e) => {
                document.querySelectorAll('.status-tab').forEach(t => t.classList.remove('active'));
                e.target.classList.add('active');
                currentFilter = e.target.dataset.filter;
                renderEvents(currentFilter);
            };
        });

        document.querySelector('.modal-close').onclick = () => { modal.style.display = 'none'; };
        window.onclick = (e) => { if(e.target === modal) modal.style.display = 'none'; };

        onAuthStateChanged(auth, (user) => {
            if (user) fetchAllEvents();
            else location.href = 'index.html';
        });
    </script>
</body>
</html>
